## C语言文件概述

我们对文件的概念已经非常熟悉了，比如常见的 Word 文档、txt 文件、源文件等。文件是数据源的一种，最主要的作用是保存数据。

在操作系统中，为了统一对各种硬件的操作，简化接口，不同的硬件设备也都被看成一个文件。对这些文件的操作，等同于对磁盘上普通文件的操作。例如，通常把显示器称为标准输出文件，printf 就是向这个文件输出，把键盘称为标准输入文件，scanf 就是从这个文件获取数据。

常见硬件设备与文件的对应关系

> 我们不去探讨硬件设备是如何被映射成文件的，大家只需要记住，在C语言中硬件设备可以看成文件，有些输入输出函数不需要你指明到底读写哪个文件，系统已经为它们设置了默认的文件，当然你也可以更改，例如让 printf 向磁盘上的文件输出数据。

操作文件的正确流程为：打开文件 --> 读写文件 --> 关闭文件。文件在进行读写操作之前要先打开，使用完毕要关闭。

所谓打开文件，就是获取文件的有关信息，例如文件名、文件状态、当前读写位置等，这些信息会被保存到一个 FILE 类型的结构体变量中。关闭文件就是断开与文件之间的联系，释放结构体变量，同时禁止再对该文件进行操作。

在C语言中，文件有多种读写方式，可以一个字符一个字符地读取，也可以读取一整行，还可以读取若干个字节。文件的读写位置也非常灵活，可以从文件开头读取，也可以从中间位置读取。

### 文件流

在《载入内存，让程序运行起来》一文中提到，所有的文件（保存在磁盘）都要载入内存才能处理，所有的数据必须写入文件（磁盘）才不会丢失。**数据在文件和内存之间传递的过程叫做文件流，类似水从一个地方流动到另一个地方。数据从文件复制到内存的过程叫做输入流，从内存保存到文件的过程叫做输出流。**

文件是数据源的一种，除了文件，还有数据库、网络、键盘等；数据传递到内存也就是保存到C语言的变量（例如整数、字符串、数组、缓冲区等）。**我们把数据在数据源和程序（内存）之间传递的过程叫做 数据流(Data Stream)** 。**相应的，数据从数据源到程序（内存）的过程叫做输入流(Input Stream)，从程序（内存）到数据源的过程叫做输出流(Output Stream)。**

输入输出（Input output，IO）是指程序（内存）与外部设备（键盘、显示器、磁盘、其他计算机等）进行交互的操作。几乎所有的程序都有输入与输出操作，如从键盘上读取数据，从本地或网络上的文件读取数据或写入数据等。通过输入和输出操作可以从外界接收信息，或者是把信息传递给外界。

我们可以说，打开文件就是打开了一个流。

-----

## C语言文件的打开与关闭

在C语言中，文件操作都是由库函数来完成的，这节介绍文件的打开和关闭。

### 文件的打开(fopen函数)

fopen() 函数用来打开一个文件，它的原型为：

```C
FILE *fopen(char *filename, char *mode);
```

filename为文件名（包括文件路径），mode为打开方式，它们都是字符串。fopen() 会获取文件信息，包括文件名、文件状态、当前读写位置等，并将这些信息保存到一个FILE类型的结构体变量中，然后将该变量的地址返回。

> FILE是在stdio.h头文件中定义的一个结构体，用来保存文件信息。

如果希望接收 fopen() 的返回值，就需要定义一个 FILE 类型的指针。例如：

```C
FILE *fp = fopen("demo.txt", "r");
```

表示以“只读”方式打开当前目录下的 demo.txt 文件，并使 fp 指向该文件，这样就可以通过 fp 来操作 demo.txt 了。fp 通常被称为文件指针。又如：

```C
FILE *fp = fopen("D:\\demo.txt","rb");
```

表示以二进制方式打开 D 盘下的 demo.txt 文件，允许读和写。

打开方式(mode)有多种，见下表：

|打开方式|说明|
|---|
|r|以只读方式打开文件，只允许读取，不允许写入。该文件必须存在。|
|r+|以读/写方式打开文件，允许读取和写入。该文件必须存在。|
|rb+|以读/写方式打开一个二进制文件，允许读/写数据。|
|rt+|以读/写方式打开一个文本文件，允许读和写。|
|w|以只写方式打开文件，若文件存在则长度清为0，即该文件内容消失，若不存在则创建该文件。|
|w+|以读/写方式打开文件，若文件存在则文件长度清为零，即该文件内容会消失。若文件不存在则建立该文件。|
|a|以追加的方式打开只写文件。若文件不存在，则会建立该文件，如果文件存在，写入的数据会被加到文件尾，即文件原先的内容会被保留（EOF符保留)。|
|a+|以追加方式打开可读/写的文件。若文件不存在，则会建立该文件，如果文件存在，则写入的数据会被加到文件尾后，即文件原先的内容会被保留（原来的EOF符 不保留)。|
|wb|以只写方式打开或新建一个二进制文件，只允许写数据。|
|wb+|以读/写方式打开或建立一个二进制文件，允许读和写。|
|wt+|以读/写方式打开或建立一个文本文件，允许读写。|
|at+|以读/写方式打开一个文本文件，允许读或在文本末追加数据。|
|ab+|以读/写方式打开一个二进制文件，允许读或在文件末追加数据|

文本文件和二进制文件的区别请查看：C语言fopen()打开文本文件与二进制文件的区别

### 几点说明

1) 文件打开方式由r、w、a、t、b、+ 六个字符拼成，各字符的含义是：

- r(read)：读
- w(write)：写
- a(append)：追加
- t(text)：文本文件，可省略不写
- b(banary)：二进制文件
- +：读和写

2) 如果没有“b”字符，文件以文本方式打开。

3) 凡用“r”打开一个文件时，该文件必须已经存在。

4) 在打开一个文件时，如果出错，fopen将返回一个空指针值NULL。在程序中可以用这一信息来判别是否完成打开文件的工作，并作相应的处理。因此常用以下程序段打开文件：

```C
if( (fp=fopen("D:\\demo.txt","rb") == NULL ){
    printf("Error on open D:\\demo.txt file!");
    getch();
    exit(1);
}
```

这段程序的意义是，如果返回的指针为空，表示不能打开D盘根目录下的 demo.txt 文件，并给出提示信息“error on open D:\\demo.txt file!”。第3行getch()的功能是从键盘输入一个字符，但不在屏幕上显示。在这里，该行的作用是等待，只有当用户从键盘敲任一键时，程序才继续执行，因此用户可利用这个等待时间阅读出错提示。敲键后执行exit(1)退出程序。

5) 把一个文本文件读入内存时，要将ASCII码转换成二进制码，而把文件以文本方式写入磁盘时，也要把二进制码转换成ASCII码，因此文本文件的读写要花费较多的转换时间。对二进制文件的读写不存在这种转换。

6) 标准输入文件 stdin（键盘）、标准输出文件 stdout（显示器）、标准错误文件 stderr（显示器）是由系统打开的，可直接使用。

###文件关闭（fclose函数）

文件一旦使用完毕，应该用fclose()函数把文件关闭，以释放相关资源，避免数据丢失。fclose() 的原型为：

```C
int fclose(FILE *fp);
```

fp 为文件指针。例如：

```C
fclose(fp);
```

文件正常关闭时，fclose() 的返回值为0，如果返回非零值则表示有错误发生。

------

## C语言中文本文件与二进制文件的区别
