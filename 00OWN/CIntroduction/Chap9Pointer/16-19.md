## C语言函数指针（指向函数的指针）

**一个函数总是占用一段连续的内存区域，函数名在表达式中有时也会被转换为该函数所在内存区域的首地址，这和数组名非常类似。我们可以把函数的这个首地址（或称入口地址）赋予一个指针变量，使指针变量指向函数所在的内存区域，然后通过指针变量就可以找到并调用该函数。这种指针就是函数指针。**

函数指针的定义形式为：
```
returnType (*pointerName)(param list);
```

returnType 为函数返回值类型，pointerNmae 为指针名称，param list 为函数参数列表。参数列表中可以同时给出参数的类型和名称，也可以只给出参数的类型，省略参数的名称，这一点和函数原型非常类似。

注意( )的优先级高于`*`，第一个括号不能省略，如果写作`returnType *pointerName(param list);`就成了函数原型，它表明函数的返回值类型为`returnType *`。

【实例】用指针来实现对函数的调用。

```C

#include <stdio.h>

//返回两个数中较大的一个
int max(int a, int b){
    return a>b ? a : b;
}

int main(){
    int x, y, maxval;
    //定义函数指针
    int (*pmax)(int, int) = max;  //也可以写作int (*pmax)(int a, int b)
    printf("Input two numbers:");
    scanf("%d %d", &x, &y);
    maxval = (*pmax)(x, y);
    printf("Max value: %d\n", maxval);
    return 0;
}
```
运行结果：
Input two numbers:10 50↙
Max value: 50

第 14 行代码对函数进行了调用。pmax 是一个函数指针，在前面加 * 就表示对它指向的函数进行调用。注意( )的优先级高于*，第一个括号不能省略。

----

## 只需一招，彻底攻克C语言指针

前面我们讲解了指针数组、二维数组指针、函数指针等几种较为复杂的指针，它们的定义形式分别是：

```C
int *p1[6];  //指针数组
int *(p2[6]);  //指针数组，和上面的形式等价
int (*p3)[6];  //二维数组指针
int (*p4)(int, int);  //函数指针
```

我相信大部分初学者对上面几种形式的指针都非常迷惑，不知道该从哪里入手去理解，为什么 p1、p2 是数组，而 p3 却是指针呢，它们仅仅是一个括号的区别。

指针是C语言中最强大最灵活的一部分，也是最难以理解的一部分，它是学习C语言的重点，没有学会指针就无从谈学会C语言。如果大家觉得上面几种形式的指针还能勉强接受，那么下面两个指针是不是让人抓狂呢？

```C
char *(* c[10])(int **p);
int (*(*(*pfunc)(int *))[5])(int *);
```

只要找到了窍门，再复杂的指针也是可以理解的，这节我们就来戳破这层窗户纸！

**C语言标准规定，对于一个符号的定义，编译器总是从它的名字开始读取，然后按照优先级顺序依次解析。对，从名字开始，不是从开头也不是从末尾，这是理解复杂指针的关键！**

对于初学者，有几种运算符的优先级非常容易混淆，它们的优先级从高到低依次是：

- 定义中被括号( )括起来的那部分。
- 后缀操作符：括号( )表示这是一个函数，方括号[ ]表示这是一个数组。
- 前缀操作符：星号*表示“指向xxx的指针”。

学会了“绝杀招式”，接下来我们就由浅入深，逐个击破上面的指针定义。

1) `int *p1[6];`

从 p1 开始理解，它的左边是 *，右边是 [ ]，[ ] 的优先级高于 *，所以编译器先解析p1[6]，p1 首先是一个拥有 6 个元素的数组，然后再解析int *，它用来说明数组元素的类型。从整体上讲，p1 是一个拥有 6 个 int * 元素的数组，也即指针数组。

2) `int (*p3)[6];`
从 p3 开始理解，( ) 的优先级最高，编译器先解析(*p3)，p3 首先是一个指针，剩下的int [6]是 p3 指向的数据的类型，它是一个拥有 6 个元素的一维数组。从整体上讲，p3 是一个指向拥有 6 个 int 元素数组的指针，也即二维数组指针。

> 为了能够通过指针来遍历数组元素，在定义数组指针时需要进行降维处理，例如三维数组指针实际指向的数据类型是二维数组，二维数组指针实际指向的数据类型是一维数组，一维数组指针实际指向的是一个基本类型；在表达式中，数组名也会进行同样的转换（下降一维）。

3) `int (*p4)(int, int);`
从 p4 开始理解，( ) 的优先级最高，编译器先解析(*p4)，p4 首先是一个指针，它后边的 ( ) 说明 p4 指向的是一个函数，括号中的int, int是参数列表，开头的int用来说明函数的返回值类型。整体来看，p4 是一个指向原型为int func(int, int);的函数的指针。

4) `char *(* c[10])(int **p);`

这个定义有两个名字，分别是 c 和 p，乍看起来 p 是指针变量的名字，不过很遗憾这是错误的。如果 p 是指针变量名，c[10]这种写法就又定义了一个新的名字，这让人匪夷所思。

以 c 作为变量的名字，先来看括号内部`（* c[10]）`：

`char * (* c[10]) (int **p);`

[ ] 的优先级高于 `*`，编译器先解析c[10]，c 首先是一个数组，它前面的`*`表明每个数组元素都是一个指针，只是还不知道指向什么类型的数据。整体上来看，`(* c[10])`说明 c 是一个指针数组，只是指针指向的数据类型尚未确定。

跳出括号，根据优先级规则（() 的优先级高于 `*`）应该先看右边（`int **p`）：

`char * (* c[10]) (int **p);`

( )说明是一个函数，`int **p`是函数参数。

再看左边（`char * `）：
```C
char * (* c[10]) (int **p);
```

char *是函数的返回值类型。

从整体上看，我们可以将定义分成两部分：

```
char * (* c[10]) (int **p);
```

绿色粗体表明 c 是一个指针数组，红色粗体表明指针指向的数据类型，合起来就是：c 是一个拥有 10 个元素的指针数组，每个指针指向一个原型为`char *func(int **p);`的函数。

5) `int (*(*(*pfunc)(int *))[5])(int *)`;

从 pfunc 开始理解，先看括号内部（`pfunc`）：

```C
int (*(*(*pfunc)(int *))[5])(int *);
```

pfunc 是一个指针。

跳出括号，看它的两边（`*(*pfunc)(int *)`）

```C
int (*(*(*pfunc)(int *))[5])(int *);
```

根据优先级规则应该先看右边的`(int *)`，它表明这是一个函数，`int *`是参数列表。再看左边的`*`，它表明函数的返回值是一个指针，只是指针指向的数据类型尚未确定。

将上面的两部分合成一个整体，如下面的蓝色粗体所示，它表明 pfunc 是一个指向函数的指针，现在函数的参数列表确定了，也知道返回值是一个指针了（只是不知道它指向什么类型的数据）。

```C
int (* (*(*pfunc)(int *)) [5])(int *);
```

`(*(*pfunc)(int *))`以外的部分，就用来说明函数返回什么类型的指针。

我们接着分析，再向外跳一层括号（`(* (*(*pfunc)(int *)) [5])`）：

```C
int (* (*(*pfunc)(int *)) [5])(int *);
```

[ ] 的优先级高于`*`，先看右边，[5] 表示这是一个数组，再看左边，`*` 表示数组的每个元素都是指针。也就是说，`*` [5] 是一个指针数组，函数返回的指针就指向这样一个数组。

那么，指针数组中的指针又指向什么类型的数据呢？再向外跳一层括号`int (* (*(*pfunc)(int *)) [5]) (int *)`：

先看橘黄色部分的右边，它是一个函数，再看左边，它是函数的返回值类型。也就是说，指针数组中的指针指向原型为`int func(int *);`的函数。

将上面的三部分合起来就是：pfunc 是一个函数指针（蓝色部分），该函数的返回值是一个指针，它指向一个指针数组（红色部分），指针数组中的指针指向原型为`int func(int *);`的函数（橘黄色部分）。

------

## 再谈main()函数，接收控制台数据

指针（Pointer）就是内存的地址，C语言允许用一个变量来存放指针，这种变量称为指针变量。指针变量可以存放基本类型数据的地址，也可以存放数组、函数以及其他指针变量的地址。

程序在运行过程中需要的是数据和指令的地址，变量名、函数名、字符串名和数组名在本质上是一样的，它们都是地址的助记符：在编写代码的过程中，我们认为变量名表示的是数据本身，而函数名、字符串名和数组名表示的是代码块或数据块的首地址；程序被编译和链接后，这些名字都会消失，取而代之的是它们对应的地址。

常见指针变量的定义

|定  义|含  义|
|---|
|int *p;|p 可以指向 int 类型的数据，也可以指向类似 int arr[n] 的数组。|
|int **p;|p 为二级指针，指向 int * 类型的数据。|
|int *p[n];|p 为指针数组。[ ] 的优先级高于 *，所以应该理解为 int *(p[n]);|
|int (*p)[n];|p 为二维数组指针。|
|int *p();|p 是一个函数，它的返回值类型为 int *。|
|int (*p)();|p 是一个函数指针，指向原型为 int func() 的函数。|

1) 指针变量可以进行加减运算，例如p++、p+i、p-=i。指针变量的加减运算并不是简单的加上或减去一个整数，而是跟指针指向的数据类型有关。

2) 给指针变量赋值时，要将一份数据的地址赋给它，不能直接赋给一个整数，例如int *p = 1000;是没有意义的，使用过程中一般会导致程序崩溃。

3) 使用指针变量之前一定要初始化，否则就不能确定指针指向哪里，如果它指向的内存没有使用权限，程序就崩溃了。对于暂时没有指向的指针，建议赋值NULL。

4) 两个指针变量可以相减。如果两个指针变量指向同一个数组中的某个元素，那么相减的结果就是两个指针之间相差的元素个数。

5) 数组也是有类型的，数组名的本意是表示一组类型相同的数据。在定义数组时，或者和 sizeof、& 运算符一起使用时数组名才表示整个数组，表达式中的数组名会被转换为一个指向数组的指针。
