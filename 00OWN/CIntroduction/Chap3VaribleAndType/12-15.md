## C语言到底使用什么编码？谁说C语言使用ASCII码，真是荒谬！

C语言是 70 年代的产物，那个时候只有 ASCII，各个国家的字符编码都还未成熟，所以C语言不可能从底层支持 GB2312、GBK、Big5、Shift-JIS 等国家编码，也不可能支持 Unicode 字符集。

稍微有点C语言基本功的读者可能认为C语言使用 ASCII 编码，字符在存储时会转换成对应的 ASCII 码值，这也是错误的，你被大学老师和教材误导了！在C语言中，只有 char 类型的窄字符才使用 ASCII 编码，char 类型的窄字符串、wchar_t 类型的宽字符和宽字符串都不使用 ASCII 编码！

wchar_t 类型的宽字符和宽字符串使用 UTF-16 或者 UTF-32 编码，这个在上节已经讲到了，现在只剩下 char 类型的窄字符串（下面称为窄字符串）没有讲了，这就是本节的重点。

对于窄字符串，C语言并没有规定使用哪一种特定的编码，只要选用的编码能够适应当前的环境即可，所以，窄字符串的编码与操作系统和编译器有关。

但是，可以肯定的说，在现代计算机中，窄字符串已经不再使用 ASCII 编码了，因为 ASCII 编码只能显示字母、数字等英文字符，对汉语、日语、韩语等其它地区的字符无能为力。

讨论窄字符串的编码要从以下两个方面下手。

### 源文件使用什么编码

源文件用来保存我们编写的代码，它最终会被存储到本地硬盘，或者远程服务器，这个时候就要尽量压缩文件体积，以节省硬盘空间或者网络流量，而代码中大部分的字符都是 ASCII 编码中的字符，用一个字节足以容纳，所以 UTF-8 编码是一个不错的选择。

UTF-8 兼容 ASCII，代码中的大部分字符可以用一个字节保存；另外 UTF-8 基于 Unicode，支持全世界的字符，我们编写的代码可以给全球的程序员使用，真正做到技术无国界。

常见的 IDE 或者编辑器，例如 Xcode、Sublime Text、Gedit、Vim 等，在创建源文件时一般也默认使用 UTF-8 编码。但是 Visual Studio 是个奇葩，它默认使用本地编码来创建源文件。

> 所谓本地编码，就是像 GBK、Big5、Shift-JIS 等这样的国家编码（地区编码）；针对不同国家发行的操作系统，默认的本地编码一般不同。简体中文本的 Windows 默认的本地编码是 GBK。

对于编译器来说，它往往支持多种编码格式的源文件。微软编译器、GCC、LLVM/Clang（内嵌于 Xcode 中）都支持 UTF-8 和本地编码的源文件，不过微软编译器还支持 UTF-16 编码的源文件。如果考虑到源文件的通用性，就只能使用 UTF-8 和本地编码了。

### 窄字符串使用什么编码

前面讲到，用 puts 或者 printf 可以输出窄字符串，代码如下：

```C
#include <stdio.h>
int main()
{
    puts("C语言中文网");
    printf("http://c.biancheng.net");
    return 0;
}
```

"C语言中文网"和"http://c.biancheng.net"就是需要被处理的窄字符串，程序运行后，它们会被载入到内存中。你看，这里面还包含了中文，肯定不能使用 ASCII 编码了。

1) 微软编译器使用本地编码来保存这些字符。不同地区的 Windows 版本默认的本地编码不一样，所以，同样的窄字符串在不同的 Windows 版本下使用的编码也不一样。对于简体中文版的 Windows，使用的是 GBK 编码。

2) GCC、LLVM/Clang 编译器使用和源文件相同的编码来保存这些字符：如果源文件使用的是 UTF-8 编码，那么这些字符也使用 UTF-8 编码；如果源文件使用的是 GBK 编码，那么这些字符也使用 GBK 编码。

**你看，对于代码中需要被处理的窄字符串，不同的编译器差别还是挺大的。不过可以肯定的是，这些字符始终都使用窄字符（多字节字符）编码。**

正是由于这些字符使用 UTF-8、GBK 等编码，而不是使用 ASCII 编码，所以它们才能包含中文。

那么，为什么很多初学者会误认为C语言使用 ASCII 编码呢？

不管是在课堂跟着老师学习，还是通过互联网自学，初学者都是从处理英文开始的，对于英文来说，使用 GBK、UTF-8、ASCII 都是一样的，GBK、UTF-8 都兼容 ASCII，初学者根本察觉不出用了哪种编码。

另外，很多大学老师和书籍作者也经常会念叨，字符在存储时会被转换成对应的 ASCII 码，在读取时又会从 ASCII 码转换成对应的字符实体，大家需要熟悉 ASCII 编码，它是C语言处理字符的基础，这从很大程度上给初学者造成一种错误印象：C语言和 ASCII 编码是绑定的，C语言使用 ASCII 编码。

### 总结

对于 char 类型的窄字符，始终使用 ASCII 编码。

对于 wchar_t 类型的宽字符和宽字符串，使用 UTF-16 或者 UTF-32 编码，它们都是基于 Unicode 字符集的。

对于 char 类型的窄字符串，微软编译器使用本地编码，GCC、LLVM/Clang 使用和源文件编码相同的编码。

另外，处理窄字符和处理宽字符使用的函数也不一样：

- <stdio.h> 头文件中的 putchar、puts、printf 函数只能用来处理窄字符；
- <wchar.h> 头文件中的 putwchar、wprintf 函数只能用来处理宽字符。

你看，仅仅是字符的处理，C语言就能玩出这么多花样，让人捉摸不透，不容易学习。这是因为，C语言是一种较为底层和古老的语言，既有历史遗留问题，又有贴近计算机底层的特性。不过，一旦搞明白这些繁杂的底层问题，你的编程内功将精进一个层次，这也许就是学习C语言的乐趣。

### 【拓展】编码字符集和运行字符集

**站在专业的角度讲，源文件使用的字符集被称为编码字符集，也就是写代码的时候使用的字符集；程序中的字符或者字符串使用的字符集被称为运行字符集，也就是程序运行后使用的字符集。**

源文件需要保存到硬盘，或者在网络上传输，使用的编码要尽量节省存储空间，同时要方便跨国交流，所以一般使用 UTF-8，这就是选择编码字符集的标准。

程序中的字符或者字符串，在程序运行后必须被载入到内存，才能进行后续的处理，对于这些字符来说，要尽量选用能够提高处理速度的编码，例如 UTF-16 和 UTF-32 编码就能够快速定位（查找）字符。

编码字符集是站在存储和传输的角度，运行字符集是站在处理或者操作的角度，所以它们并不一定相同。

## C语言转义字符

字符集（Character Set）为每个字符分配了唯一的编号，我们不妨将它称为编码值。在C语言中，一个字符除了可以用它的实体（也就是真正的字符）表示，还可以用编码值表示。这种使用编码值来间接地表示字符的方式称为转义字符（Escape Character）。

转义字符以`\`或者`\x`开头，以`\`开头表示后跟八进制形式的编码值，以`\x`开头表示后跟十六进制形式的编码值。对于转义字符来说，只能使用八进制或者十六进制。

字符 1、2、3、a、b、c 对应的 ASCII 码的八进制形式分别是 61、62、63、141、142、143，十六进制形式分别是 31、32、33、61、62、63。下面的例子演示了转义字符的用法：

```C
char a = '\61';  //字符1
char b = '\141';  //字符a
char c = '\x31';  //字符1
char d = '\x61';  //字符a
char *str1 = "\x31\x32\x33\x61\x62\x63";  //字符串"123abc"
char *str2 = "\61\62\63\141\142\143";  //字符串"123abc"
char *str3 = "The string is: \61\62\63\x61\x62\x63"  //混用八进制和十六进制形式
```

> \x31\x32经常会在网络字节中发现，个人推测是因为能将10进制转为16进制，减少传输长度。

转义字符既可以用于单个字符，也可以用于字符串，并且一个字符串中可以同时使用八进制形式和十六进制形式。

一个完整的例子：

```C
#include <stdio.h>
int main(){
    puts("\x68\164\164\x70://c.biancheng.\x6e\145\x74");
    return 0;
}
```

运行结果：
http://c.biancheng.net

转义字符的初衷是用于 ASCII 编码，所以它的取值范围有限：

- 八进制形式的转义字符最多后跟三个数字，也即\ddd，最大取值是\177；
- 十六进制形式的转义字符最多后跟两个数字，也即\xdd，最大取值是\7f。

超出范围的转义字符的行为是未定义的，有的编译器会将编码值直接输出，有的编译器会报错。

对于 ASCII 编码，0~31（十进制）范围内的字符为控制字符，它们都是看不见的，不能在显示器上显示，甚至无法从键盘输入，只能用转义字符的形式来表示。不过，直接使用 ASCII 码记忆不方便，也不容易理解，所以，针对常用的控制字符，C语言又定义了简写方式，完整的列表如下：

|转义字符|意义|ASCII码值（十进制）|
|--|
|\a|响铃(BEL)|007|
|\b|退格(BS) ，将当前位置移到前一列|008|
|\f|换页(FF)，将当前位置移到下页开头|012|
|\n|换行(LF) ，将当前位置移到下一行开头|010|
|\r|回车(CR) ，将当前位置移到本行开头|013|
|\t|水平制表(HT)|009|
|\v|垂直制表(VT)|011|
|\'|单引号|039|
|\"|双引号|034|
|\\|反斜杠|93|

\n和\t是最常用的两个转义字符：

- \n用来换行，让文本从下一行的开头输出，前面的章节中已经多次使用；
- \t用来占位，一般相当于四个空格，或者 tab 键的功能。

单引号、双引号、反斜杠是特殊的字符，不能直接表示：

- 单引号是字符类型的开头和结尾，要使用\'表示，也即'\''；
- 双引号是字符串的开头和结尾，要使用\"表示，也即"abc\"123"；
- 反斜杠是转义字符的开头，要使用\\表示，也即'\\'，或者"abc\\123"。

转义字符示例：
```C
#include <stdio.h>
int main(){
    puts("C\tC++\tJava\n\"C\" first appeared!");
    return 0;
}
```

运行结果：
C    C++    Java
"C" first appeared!

## C语言标识符、关键字、注释、表达式和语句

这一节主要讲解C语言中的几个基本概念。

### 标识符

定义变量时，我们使用了诸如 a、abc、mn123 这样的名字，它们都是程序员自己起的，一般能够表达出变量的作用，这叫做标识符（Identifier）。

标识符就是程序员自己起的名字，除了变量名，后面还会讲到函数名、宏名、结构体名等，它们都是标识符。不过，名字也不能随便起，要遵守规范；C语言规定，**标识符只能由字母（A~Z, a~z）、数字（0~9）和下划线（_）组成，并且第一个字符必须是字母或下划线，不能是数字。**

以下是合法的标识符：
a, x,  x3, BOOK_1, sum5

以下是非法的标识符：

- 3s    不能以数字开头
- s*T    出现非法字符*
- -3x    不能以减号（-）开头
- bowy-1    出现非法字符减号（-）

在使用标识符时还必须注意以下几点：

- C语言虽然不限制标识符的长度，但是它受到不同编译器的限制，同时也受到操作系统的限制。例如在某个编译器中规定标识符前128位有效，当两个标识符前128位相同时，则被认为是同一个标识符。
- 在标识符中，大小写是有区别的，例如 BOOK 和 book 是两个不同的标识符。
- 标识符虽然可由程序员随意定义，但标识符是用于标识某个量的符号，因此，命名应尽量有相应的意义，以便于阅读和理解，作到“顾名思义”。

### 关键字

关键字（Keywords）是由C语言规定的具有特定意义的字符串，通常也称为保留字，例如 int、char、long、float、unsigned 等。我们定义的标识符不能与关键字相同，否则会出现错误。

 > 你也可以将关键字理解为具有特殊含义的标识符，它们已经被系统使用，我们不能再使用了。

标准C语言中一共规定了32个关键字，大家可以参考C语言关键字及其解释[共32个]，后续我们会一一讲解。

### 注释

注释（Comments）可以出现在代码中的任何位置，用来向用户提示或解释代码的含义。程序编译时，会忽略注释，不做任何处理，就好像它不存在一样。

C语言支持单行注释和多行注释：

- 单行注释以//开头，直到本行末尾（不能换行）；
- 多行注释以/*开头，以*/结尾，注释内容可以有一行或多行。

一个使用注释的例子：

```C
/*
  Powered by: c.biancheng.net
  Author: 严长生
  Date: 2017-10-25
*/
#include <stdio.h>
int main()
{
    /* puts 会在末尾自动添加换行符 */
    puts("http://c.biancheng.net");
    printf("C语言中文网\n");  //printf要手动添加换行符
    return 0;
}
```

运行结果：
http://c.biancheng.net
C语言中文网

在调试程序的过程中可以将暂时将不使用的语句注释掉，使编译器跳过不作处理，待调试结束后再去掉注释。

需要注意的是，多行注释不能嵌套使用。例如下面的注释是错误的：
/*C语言/*中文*/网*/
而下面的注释是正确的：
/*C语言中文网*/  /*c.biancheng.net*/

## 表达式（Expression）和语句（Statement）

其实前面我们已经多次提到了「表达式」和「语句」这两个概念，相信读者在耳濡目染之中也已经略知一二了，本节我们不妨再重点介绍一下。

表达式（Expression）和语句（Statement）的概念在C语言中并没有明确的定义：
- 表达式可以看做一个计算的公式，往往由数据、变量、运算符等组成，例如3*4+5、a=c=d等，表达式的结果必定是一个值；
- 语句的范围更加广泛，不一定是计算，不一定有值，可以是某个操作、某个函数、选择结构、循环等。

赶紧划重点：
表达式必须有一个执行结果，这个结果必须是一个值，例如3*4+5的结果 17，a=c=d=10的结果是 10，printf("hello")的结果是 5（printf 的返回值是成功打印的字符的个数）。
以分号;结束的往往称为语句，而不是表达式，例如3*4+5;、a=c=d;等。

## C语言加减乘除运算

加减乘除是常见的数学运算，C语言当然支持，不过，C语言中的运算符号与数学中的略有不同，请见下表。

| |加法|减法|乘法|除法|求余数（取余）|
|---|
|数学|+|-|×|÷|无|
|C语言|+|-|*|/|%|

C语言中的加号、减号与数学中的一样，乘号、除号不同；另外C语言还多了一个求余数的运算符，就是 %。|

下面的代码演示了如何在C语言中进行加减乘除运算：

```C

#include <stdio.h>
int main()
{
    int a = 12;
    int b = 100;
    float c = 8.5;
    int m = a + b;
    float n = b * c;
    double p = a / c;
    int q = b % a;
    printf("m=%d, n=%f, p=%lf, q=%d\n", m, n, p, q);
    return 0;
}

```

输出结果：
m=112, n=850.000000, p=1.411765, q=4

你也可以让数字直接参与运算：

```C
#include <stdio.h>
int main()
{
    int a = 12;
    int b = 100;
    float c = 8.9;
    int m = a - b;  // 变量参与运算
    int n = a + 239;  // 有变量也有数字
    double p = 12.7 * 34.3;  // 数字直接参与运算

    printf("m=%d, n=%d, p=%lf\n", m, n, p);
    printf("m*2=%d, 6/3=%d, m*n=%ld\n", m*2, 6/3, m*n);

    return 0;
}
```
输出结果：
m=-88, n=251, p=435.610000
m*2=-176, 6/3=2, m*n=-22088

### 对除法的说明

C语言中的除法运算有点奇怪，不同类型的除数和被除数会导致不同类型的运算结果：

- 当除数和被除数都是整数时，运算结果也是整数；如果不能整除，那么就直接丢掉小数部分，只保留整数部分，这跟将小数赋值给整数类型是一个道理。
- **一旦除数和被除数中有一个是小数，那么运算结果也是小数，并且是 double 类型的小数。**

请看下面的代码：

```C
#include <stdio.h>
int main()
{
    int a = 100;
    int b = 12;
    float c = 12.0;

    double p = a / b;
    double q = a / c;

    printf("p=%lf, q=%lf\n", p, q);

    return 0;
}
```

运行结果：
p=8.000000, q=8.333333

a 和 b 都是整数，a / b 的结果也是整数，所以赋值给 p 变量的也是一个整数，这个整数就是 8。

另外需要注意的一点是除数不能为 0，因为任何一个数字除以 0 都没有意义。

然而，编译器对这个错误一般无能为力，很多情况下，编译器在编译阶段根本无法计算出除数的值，不能进行有效预测，“除数为 0”这个错误只能等到程序运行后才能发现，而程序一旦在运行阶段出现任何错误，只能有一个结果，那就是崩溃，并被操作系统终止运行。

请看下面的代码：

```C
#include <stdio.h>
int main()
{
    int a, b;
    scanf("%d %d", &a, &b);  //从控制台读取数据并分别赋值给a和b
    printf("result=%d\n", a / b);

    return 0;
}
```

> 这段代码用到了一个新的函数，就是 scanf。scanf 和 printf 的功能相反，printf 用来输出数据，scanf 用来读取数据。此处，scanf 会从控制台读取两个整数，并分别赋值给 a 和 b。关于 scanf 的具体用法，我们将在《C语言从键盘输入数据》一节中详细讲解，这里大家只要知道它的作用就可以了，不必求甚解。

程序开头定义了两个 int 类型的变量 a 和 b，程序运行后，从控制台读取用户输入的整数，并分别赋值给 a 和 b，这个时候才能知道 a 和 b 的具体值，才能知道除数 b 是不是 0。像这种情况，b 的值在程序运行期间会改变，跟用户输入的数据有关，编译器根本无法预测，所以就没法及时发现“除数为 0”这个错误。

### 对取余运算的说明

**取余，也就是求余数，使用的运算符是 %。C语言中的取余运算只能针对整数，也就是说，% 的两边都必须是整数，不能出现小数，否则编译器会报错。**

另外，余数可以是正数也可以是负数，由 % 左边的整数决定：

- 如果 % 左边是正数，那么余数也是正数；
- 如果 % 左边是负数，那么余数也是负数。

跟左右无关。

请看下面的例子：
```C
#include <stdio.h>
int main()
{
    printf(
        "100%%12=%d \n100%%-12=%d \n-100%%12=%d \n-100%%-12=%d \n",
        100%12, 100%-12, -100%12, -100%-12
    );
    return 0;
}
```

在 printf 中，% 是格式控制符的开头，是一个特殊的字符，不能直接输出；要想输出 %，必须在它的前面再加一个 %，这个时候 % 就变成了普通的字符，而不是用来表示格式控制符了。

### 加减乘除运算的简写

有时候我们希望对一个变量进行某种运算，然后再把运算结果赋值给变量本身，请看下面的例子：

```C
#include <stdio.h>
int main()
{
    int a = 12;
    int b = 10;
    printf("a=%d\n", a);
    a = a + 8;
    printf("a=%d\n", a);
    a = a * b;
    printf("a=%d\n", a);
    return 0;
}
```

输出结果：
a=12
a=20
a=200

a = a + 8相当于用原来 a 的值（也即12）加上 8，再把运算结果（也即20）赋值给 a，此时 a 的值就变成了 20。

a = a * b相当于用原来 a 的值（也即20）乘以 b 的值（也即10），再把运算结果（也即200）赋值给 a，此时 a 的值就变成了 200。

以上的操作，可以理解为对变量本身进行某种运算。

在C语言中，对变量本身进行运算可以有简写形式。假设用 # 来表示某种运算符，那么

```C
a = a # b
```

可以简写为：

```C
a #= b
```

`#` 表示 +、-、*、/、% 中的任何一种运算符。

上例中`a = a + 8`可以简写为`a += 8，a = a * b`可以简写为`a *= b`。

下面的简写形式也是正确的：

```C
int a = 10, b = 20;
a += 10;  //相当于 a = a + 10;
a *= (b-10);  //相当于 a = a * (b-10);
a -= (a+20);  //相当于 a = a - (a+20);
```

注意：a #= b 仅是一种简写形式，不会影响程序的执行效率。
